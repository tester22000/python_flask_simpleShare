<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>심플 공유 앱</title>
    <link href="static/css/tailwind.min.css" rel="stylesheet">
    <script src="static/js/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
    <div class="container mx-auto p-4 flex-grow">
        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
            {% for message in messages %}
            <p class="font-semibold">{{ message }}</p>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="w-full md:w-1/3">
                    <label for="filter-type" class="block text-gray-700 font-semibold mb-2">유형</label>
                    <select id="filter-type" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">전체</option>
                        {% for type in content_types %}
                        <option value="{{ type.type }}">{{ type.type }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="w-full md:w-2/3">
                    <label for="search-query" class="block text-gray-700 font-semibold mb-2">검색</label>
                    <input type="text" id="search-query" placeholder="검색어를 입력하세요..." class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div class="fixed top-0 right-0 p-6 z-50">
                <div class="flex flex-row items-end gap-4">
                    <a href="{{ url_for('routes.qr_code_page') }}" class="flex items-center justify-center w-12 h-12 rounded-full shadow-lg bg-indigo-500 hover:bg-indigo-600 transition-colors text-white text-2xl">
                        <svg width="24px" height="24px" fill="#FFFFFF" viewBox="0 -960 960 960"><path d="M120-520v-320h320v320H120Zm80-80h160v-160H200v160Zm-80 480v-320h320v320H120Zm80-80h160v-160H200v160Zm320-320v-320h320v320H520Zm80-80h160v-160H600v160Zm160 480v-80h80v80h-80ZM520-360v-80h80v80h-80Zm80 80v-80h80v80h-80Zm-80 80v-80h80v80h-80Zm80 80v-80h80v80h-80Zm80-80v-80h80v80h-80Zm0-160v-80h80v80h-80Zm80 80v-80h80v80h-80Z"/></svg>
                    </a>
                    <a href="{{ url_for('routes.create_text_form') }}" class="flex items-center justify-center w-12 h-12 rounded-full shadow-lg bg-green-500 hover:bg-green-600 transition-colors text-white text-2xl">
                        <svg width="24px" height="24px"  viewBox="0 -960 960 960" fill="#FFFFFF"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h240v80H200v560h560v-240h80v240q0 33-23.5 56.5T760-120H200Zm440-400v-120H520v-80h120v-120h80v120h120v80H720v120h-80Z"/></svg>
                    </a>
                    <a href="{{ url_for('routes.upload_file_form') }}" class="flex items-center justify-center w-12 h-12 rounded-full shadow-lg bg-blue-500 hover:bg-blue-600 transition-colors text-white text-2xl">
                        <svg width="24px" height="24px"  viewBox="0 -960 960 960" fill="#FFFFFF"><path d="M440-320v-326L336-542l-56-58 200-200 200 200-56 58-104-104v326h-80ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"/></svg>
                    </a>
                </div>
            </div>
        </div>

        <div id="content-list" class="space-y-4">
            </div>

        <div id="loading-spinner" class="flex justify-center py-4 hidden">
            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
    </div>

    <script>
        let currentPage = 0;
        let isLoading = false;
        let isLastPage = false;
        const limit = 10;
        
        // 목록 로드 함수
        function loadContents() {
            if (isLoading || isLastPage) return;
            isLoading = true;
            $('#loading-spinner').removeClass('hidden');

            const query = $('#search-query').val();
            const type = $('#filter-type').val();

            $.ajax({
                url: "{{ url_for('routes.get_contents_api') }}",
                data: { page: currentPage, q: query, type: type },
                dataType: 'json',
                success: function(data) {
                    $('#loading-spinner').addClass('hidden');
                    isLoading = false;

                    if (data.length === 0 && currentPage === 0) {
                        $('#content-list').html('<p class="text-center text-gray-500">등록된 콘텐츠가 없습니다.</p>');
                        isLastPage = true;
                        return;
                    }
                    if (data.length < limit) {
                        isLastPage = true;
                    }

                    // 콘텐츠 목록 동적으로 추가
                    data.forEach(function(content) {
                        const contentHtml = `
                            <div class="bg-white rounded-lg shadow-md p-4 flex items-center justify-between">
                                <div class="flex items-center space-x-4 flex-grow">
                                    <span class="text-gray-500 font-semibold uppercase text-sm">${content.type}</span>
                                    <a href="${content.type === 'text' ? '{{ url_for("routes.view_content", content_id="CONTENT_ID") }}'.replace('CONTENT_ID', content.id) : '{{ url_for("routes.download_content", content_id="CONTENT_ID") }}'.replace('CONTENT_ID', content.id)}" class="flex-grow text-blue-600 hover:underline overflow-hidden whitespace-nowrap overflow-ellipsis max-w-xs">
                                        ${content.preview}
                                    </a>
                                </div>
                                <div class="flex-shrink-0">
                                    <button class="delete-btn text-red-500 hover:text-red-700 transition-colors ml-4" data-id="${content.id}">
                                        <svg width="24px" height="24px" fill="#550000" viewBox="0 -960 960 960"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg>
                                    </button>
                                </div>
                            </div>
                        `;
                        $('#content-list').append(contentHtml);
                    });
                    currentPage++;
                },
                error: function() {
                    $('#loading-spinner').addClass('hidden');
                    isLoading = false;
                    console.error("Failed to load contents.");
                }
            });
        }
        
        // 검색/필터 변경 시 목록 초기화 후 재로드
        $('#search-query, #filter-type').on('input change', function() {
            currentPage = 0;
            isLastPage = false;
            $('#content-list').empty();
            loadContents();
        });

        // 무한 스크롤 이벤트
        $(window).scroll(function() {
            if ($(window).scrollTop() + $(window).height() >= $(document).height() - 500) {
                loadContents();
            }
        });

        // 삭제 버튼 클릭 이벤트 위임
        $(document).on('click', '.delete-btn', function() {
            if (confirm('정말로 삭제하시겠습니까?')) {
                const contentId = $(this).data('id');
                $.ajax({
                    url: `{{ url_for('routes.delete_content', content_id='DUMMY') }}`.replace('DUMMY', contentId),
                    type: 'DELETE',
                    success: function() {
                        alert('삭제되었습니다.');
                        location.reload(); // 페이지 새로고침
                    },
                    error: function() {
                        alert('삭제에 실패했습니다.');
                    }
                });
            }
        });

        // 페이지 로드 시 초기 콘텐츠 로드
        $(document).ready(function() {
            loadContents();
        });
    </script>
</body>
</html>